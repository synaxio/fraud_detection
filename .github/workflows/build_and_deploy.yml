name: Build and Deploy to HuggingFace

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout du repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3Ô∏è‚É£ Installer les d√©pendances
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest mlflow pandas

      - name: Export env vars
        run: |
          echo "MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_TOKEN=${{ secrets.MLFLOW_TRACKING_TOKEN }}" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION }}" >> $GITHUB_ENV
          echo "MLFLOW_S3_ENDPOINT_URL=${{ secrets.MLFLOW_S3_ENDPOINT_URL }}" >> $GITHUB_ENV
          echo "API_URL=${{ secrets.API_URL }}" >> $GITHUB_ENV
          echo "EXPERIMENT_NAME=${{ secrets.MLFLOW_S3_ENDPOINT_URL }}" >> $GITHUB_ENV
          echo "BUCKET_NAME=${{ secrets.BUCKET_NAME }}" >> $GITHUB_ENV
          echo "ARTIFACT_ROOT=${{ secrets.ARTIFACT_ROOT }}" >> $GITHUB_ENV
          echo "BACKEND_STORE_URI=${{ secrets.BACKEND_STORE_URI }}" >> $GITHUB_ENV


      # 4Ô∏è‚É£ Ex√©cuter les tests
      - name: Run pytest
        run: |
          pytest tests/ --maxfail=1 --disable-warnings -v --junitxml=report.xml


  build-deploy:
    name: Build Docker and Deploy on HugginFace
    runs-on: ubuntu-latest
    needs: test

    steps:
    

      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install MLflow + boto3
        run: pip install mlflow boto3

      - name: Download latest MLflow model
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_TOKEN: ${{ secrets.MLFLOW_TRACKING_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          MLFLOW_S3_ENDPOINT_URL: ${{ secrets.MLFLOW_S3_ENDPOINT_URL }}
        run: |
          python - <<'EOF'
          import mlflow
          import os
          import shutil
          from mlflow.tracking import MlflowClient

          EXPERIMENT_NAME = 'fraud_detector'

          # R√©cup√©rer l'exp√©rience
          exp = mlflow.get_experiment_by_name(EXPERIMENT_NAME)
          exp_id = exp.experiment_id

          # Chercher le dernier run r√©ussi
          runs = mlflow.search_runs(
              [exp_id], 
              filter_string="attributes.status = 'FINISHED'",        
              order_by=["attributes.start_time DESC"],
              max_results=1
          )
          
          last_run_id = runs.iloc[0]["run_id"]
          print(f"Last run ID: {last_run_id}")

          # Supprimer le dossier pr√©c√©dent
          shutil.rmtree("model", ignore_errors=True)
          print("Old model directory removed.")

          # T√©l√©charger directement fraud_detector
          # On √©vite list_artifacts qui cause des probl√®mes avec certains MLflow servers
          model_uri = f"runs:/{last_run_id}/fraud_detector"
          print(f"Downloading from: {model_uri}")
          
          try:
              local_path = mlflow.artifacts.download_artifacts(
                  artifact_uri=model_uri,
                  dst_path="."
              )
              print(f"Downloaded to: {local_path}")
              
              # Chercher le dossier 'code' dans la structure t√©l√©charg√©e
              if os.path.exists("fraud_detector/code/MLmodel"):
                  print("Found MLmodel in fraud_detector/code/")
                  shutil.move("fraud_detector/code", "model")
                  shutil.rmtree("fraud_detector", ignore_errors=True)
                  print("Moved fraud_detector/code to model/")
              elif os.path.exists("fraud_detector/MLmodel"):
                  print("Found MLmodel in fraud_detector/")
                  shutil.move("fraud_detector", "model")
                  print("Moved fraud_detector to model/")
              else:
                  # Chercher MLmodel n'importe o√π dans fraud_detector
                  for root, dirs, files in os.walk("fraud_detector"):
                      if "MLmodel" in files:
                          print(f"Found MLmodel in {root}")
                          shutil.move(root, "model")
                          shutil.rmtree("fraud_detector", ignore_errors=True)
                          break
              
          except Exception as e:
              print(f"Error: {e}")
              raise
          
          # V√©rifier que MLmodel existe
          if not os.path.exists("model/MLmodel"):
              print("\n‚ùå MLmodel file not found!")
              print("Contents of current directory:")
              for item in os.listdir("."):
                  print(f"  - {item}")
                  if os.path.isdir(item):
                      print(f"    Contents of {item}:")
                      for root, dirs, files in os.walk(item):
                          level = root.replace(item, "").count(os.sep)
                          indent = " " * 2 * level
                          print(f"{indent}{os.path.basename(root)}/")
                          subindent = " " * 2 * (level + 1)
                          for f in files[:5]:
                              print(f"{subindent}{f}")
              raise Exception("MLmodel file not found in downloaded artifacts!")
          
          print("\n‚úì Model downloaded successfully")
          
          # Afficher la structure
          print("\n=== Final model structure ===")
          for root, dirs, files in os.walk("model"):
              level = root.replace("model", "").count(os.sep)
              indent = " " * 2 * level
              print(f"{indent}{os.path.basename(root)}/")
              subindent = " " * 2 * (level + 1)
              for file in files[:8]:
                  print(f"{subindent}{file}")
              if len(files) > 8:
                  print(f"{subindent}... and {len(files) - 8} more files")
          
          EOF

      - name: Deploy to HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          git clone https://oauth2:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/${{ secrets.HF_USERNAME }}/api-prediction space_repo
          cd space_repo
          
          # Copier le Dockerfile
          cp ../docker/Dockerfile ./Dockerfile
          
          # Copier le dossier model
          rm -rf model
          cp -r ../model ./model
          
          # Copier le dossier api
          rm -rf api
          cp -r ../api ./api
          
          # Copier requirements.txt
          cp ../requirements.txt ./requirements.txt
          
          cat > README.md <<'EOL'
          ---
          title: API Prediction
          emoji: üîÆ
          colorFrom: blue
          colorTo: green
          sdk: docker
          app_port: 7860
          pinned: false
          ---
          
          Last deployed: $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          EOL
          
          git add .
          git diff --staged --quiet || (git commit -m "Deploy from GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S')" && git push)