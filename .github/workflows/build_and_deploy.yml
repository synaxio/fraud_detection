name: Build and Deploy to HuggingFace

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install MLflow + boto3
      run: pip install mlflow boto3

    - name: Download latest MLflow model
      env:
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        MLFLOW_TRACKING_TOKEN: ${{ secrets.MLFLOW_TRACKING_TOKEN }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        MLFLOW_S3_ENDPOINT_URL: ${{ secrets.MLFLOW_S3_ENDPOINT_URL }}
               
        #EXPERIMENT_NAME: ${{ secrets.EXPERIMENT_NAME }}
      run: |
        python - <<EOF
        import mlflow, os, shutil

        EXPERIMENT_NAME = 'fraud_detector' #os.getenv("EXPERIMENT_NAME")

        exp = mlflow.get_experiment_by_name(EXPERIMENT_NAME)
        exp_id = exp.experiment_id
        #runs = mlflow.search_runs(exp.experiment_id, order_by=["start_time DESC"])
        runs = mlflow.search_runs([exp_id], 
                                filter_string="attributes.status = 'FINISHED'",        
                                order_by=["attributes.start_time DESC"],  # du plus rÃ©cent au plus ancien
                                max_results=1
                                )
        last_run_id = runs.iloc[0]["run_id"]
        #last_run_id = runs.iloc[0].run_id

        from mlflow.tracking import MlflowClient
        client = MlflowClient()

        model_uri = f"runs:/{last_run_id}/{EXPERIMENT_NAME}/code" 

        print(f"Model URI: {model_uri}")

        # Supprimer le dossier prÃ©cÃ©dent
        shutil.rmtree("model", ignore_errors=True)
        print("Old model directory removed.")

        # TÃ©lÃ©charger les artifacts (ajustez le chemin selon vos artifacts)
        # Option 1 : Si votre modÃ¨le est enregistrÃ© comme "model"
        artifact_path = "model"
        
        # Option 2 : Si c'est sous un autre nom, utilisez celui affichÃ© ci-dessus
        artifact_path = "fraud_detector"  # ou autre selon votre log
        
        try:
            model_uri = f"runs:/{last_run_id}/{artifact_path}"
            print(f"Downloading from: {model_uri}")
            
            # TÃ©lÃ©charger les artifacts sur disque
            local_path = mlflow.artifacts.download_artifacts(
                artifact_uri=model_uri,
                dst_path="model"
            )
            print(f"Model downloaded to: {local_path}")
            
        except Exception as e:
            print(f"Error with artifact_path '{artifact_path}': {e}")
            print("Trying to download all artifacts...")
            # Alternative : tÃ©lÃ©charger tous les artifacts du run
            local_path = mlflow.artifacts.download_artifacts(
                run_id=last_run_id,
                dst_path="model"
            )
            print(f"All artifacts downloaded to: {local_path}")
        EOF
    
    - name: Initialize HuggingFace Space if needed
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        pip install huggingface_hub
        
        python - <<EOF
        from huggingface_hub import HfApi
        
        api = HfApi(token="${{ secrets.HF_TOKEN }}")
        repo_id = "${{ secrets.HF_USERNAME }}/api-prediction"
        
        try:
            # VÃ©rifier si le README existe
            api.hf_hub_download(repo_id=repo_id, filename="README.md", repo_type="space")
            print("Space dÃ©jÃ  initialisÃ©")
        except:
            print("Initialisation du Space...")
            # CrÃ©er le README.md initial
            readme_content = """---
        title: API Prediction
        emoji: ðŸ”®
        colorFrom: blue
        colorTo: green
        sdk: docker
        app_port: 7860
        pinned: false
        ---
        
        # API Prediction
        
        API de prÃ©diction dÃ©ployÃ©e automatiquement via GitHub Actions.
        """
            api.upload_file(
                path_or_fileobj=readme_content.encode(),
                path_in_repo="README.md",
                repo_id=repo_id,
                repo_type="space",
                token="${{ secrets.HF_TOKEN }}"
            )
            print("Space initialisÃ© avec succÃ¨s")
        EOF
    
    - name: Login HuggingFace registry
      run: |
        echo "${{ secrets.HF_TOKEN }}" | docker login -u ${{ secrets.HF_USERNAME }} --password-stdin registry.hf.space

    - name: Build image
      run: |
        # VÃ©rifiez que le nom correspond EXACTEMENT Ã  votre Space existant
        docker build -t registry.hf.space/${{ secrets.HF_USERNAME }}/api-prediction -f docker/Dockerfile .

    - name: Deploy to HuggingFace Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
            git config --global user.email "github-actions@github.com"
            git config --global user.name "GitHub Actions"
            
            git clone https://oauth2:${{ secrets.HF_TOKEN }}@huggingface.co/spaces/${{ secrets.HF_USERNAME }}/api-prediction space_repo
            cd space_repo
            
            # Copier le Dockerfile
            cp ../docker/Dockerfile ./Dockerfile
            
            # Copier le dossier model
            rm -rf model
            cp -r ../model ./model
            
            # Copier le dossier api (IMPORTANT!)
            rm -rf api
            cp -r ../api ./api
            
            # Copier requirements.txt
            cp ../requirements.txt ./requirements.txt

            cp ../api/model_loader.py ./model_loader.py
            
            # Copier tout autre fichier nÃ©cessaire mentionnÃ© dans votre Dockerfile
            # Par exemple, si vous avez un main.py, app.py, etc.
            # cp ../main.py ./main.py
            
            cat > README.md <<'EOL'
            ---
            title: API Prediction
            emoji: ðŸ”®
            colorFrom: blue
            colorTo: green
            sdk: docker
            app_port: 7860
            pinned: false
            ---
            EOL
            
            git add .
            git diff --staged --quiet || (git commit -m "Deploy from GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S')" && git push)
