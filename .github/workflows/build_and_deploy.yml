name: Build and Deploy to HuggingFace

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install MLflow + boto3
      run: pip install mlflow boto3

    - name: Download latest MLflow model
      env:
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        MLFLOW_TRACKING_TOKEN: ${{ secrets.MLFLOW_TRACKING_TOKEN }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
        MLFLOW_S3_ENDPOINT_URL: ${{ secrets.MLFLOW_S3_ENDPOINT_URL }}
               
        #EXPERIMENT_NAME: ${{ secrets.EXPERIMENT_NAME }}
      run: |
        python - <<EOF
        import mlflow, os, shutil

        EXPERIMENT_NAME = 'fraud_detector' #os.getenv("EXPERIMENT_NAME")

        exp = mlflow.get_experiment_by_name(EXPERIMENT_NAME)
        exp_id = exp.experiment_id
        #runs = mlflow.search_runs(exp.experiment_id, order_by=["start_time DESC"])
        runs = mlflow.search_runs([exp_id], 
                                filter_string="attributes.status = 'FINISHED'",        
                                order_by=["attributes.start_time DESC"],  # du plus récent au plus ancien
                                max_results=1
                                )
        last_run_id = runs.iloc[0]["run_id"]
        #last_run_id = runs.iloc[0].run_id

        from mlflow.tracking import MlflowClient
        client = MlflowClient()

        model_uri = f"runs:/{last_run_id}/{EXPERIMENT_NAME}/code" 

        print(f"Model URI: {model_uri}")

        # Supprimer le dossier précédent
        shutil.rmtree("model", ignore_errors=True)
        print("Old model directory removed.")

        # Télécharger les artifacts (ajustez le chemin selon vos artifacts)
        # Option 1 : Si votre modèle est enregistré comme "model"
        artifact_path = "model"
        
        # Option 2 : Si c'est sous un autre nom, utilisez celui affiché ci-dessus
        artifact_path = "fraud_detector"  # ou autre selon votre log
        
        try:
            model_uri = f"runs:/{last_run_id}/{artifact_path}"
            print(f"Downloading from: {model_uri}")
            
            # Télécharger les artifacts sur disque
            local_path = mlflow.artifacts.download_artifacts(
                artifact_uri=model_uri,
                dst_path="model"
            )
            print(f"Model downloaded to: {local_path}")
            
        except Exception as e:
            print(f"Error with artifact_path '{artifact_path}': {e}")
            print("Trying to download all artifacts...")
            # Alternative : télécharger tous les artifacts du run
            local_path = mlflow.artifacts.download_artifacts(
                run_id=last_run_id,
                dst_path="model"
            )
            print(f"All artifacts downloaded to: {local_path}")
        EOF

    - name: Login HuggingFace registry
      run: |
        echo "${{ secrets.HF_TOKEN }}" | docker login -u ${{ secrets.HF_USERNAME }} --password-stdin registry.hf.space

    - name: Build image
      run: docker build -f docker/Dockerfile -t hf.co/${{ secrets.HF_USERNAME }}/api-prediction:latest -f docker/Dockerfile .

    - name: Push image
      run: docker push hf.co/${{ secrets.HF_USERNAME }}/api-prediction:latest
